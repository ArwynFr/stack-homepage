version: "3.7"

services:
  web:
    image: ${STACK_IMAGE}
    networks:
      - reverse
    configs:
      - source: expires
        target: /etc/nginx/conf.d/expires.conf
      - source: gzip
        target: /etc/nginx/conf.d/gzip.conf
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.services.homepage.loadBalancer.server.port=8080"
        - "traefik.http.routers.homepage.rule=Host(`arwyn.fr`,`www.arwyn.fr`)"
        - "traefik.http.routers.homepage.middlewares=redirect@file,secure@file"
        - "traefik.http.routers.homepage.service=homepage"
        - "traefik.http.routers.homepage.tls.options=secure@file"
        - "traefik.http.routers.homepage.tls.certResolver=gandi"        
    read_only: true
    volumes:
      - tmpfs:/tmp

networks:
  reverse:
    external: true

configs:
  expires:
    file: ./expires.conf
    name: expires-${STACK_VERSION}
  gzip:
    file: ./gzip.conf
    name: gzip-${STACK_VERSION}

volumes:
  tmpfs:
    driver_opts:
      type: tmpfs
      device: tmpfs