name: deployment

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  OCI_REGISTRY: ghcr.io
  HELM_RELEASE: homepage
  KUBE_NAMESPACE: arwynfr
  PACKAGE_DOCKER: homepage-docker
  PACKAGE_HELM: homepage-helm
  PATH_CA_FILE: ./ca.crt
  PATH_DOCKER_CONTEXT: ./src
  PATH_HELM_CHART: ./build/helm

jobs:
  deployment:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”“ Docker login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.OCI_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: ðŸ”¨ Git checkout
        uses: actions/checkout@v6

      - name: ðŸ”¨ Version number
        run: ./build/version/New-ReleaseVersion.ps1
        shell: pwsh
        id: version

      - name: ðŸ”¨ CA certificate
        run: echo '${{ secrets.AUTHORITY}}' > ${PATH_CA_FILE}

      - name: ðŸ“¦ Build Docker image
        run: docker build ${PATH_DOCKER_CONTEXT} --tag ${OCI_REGISTRY}/${GITHUB_REPOSITORY@L}/${PACKAGE_DOCKER}:${{ steps.version.outputs.version }}

      - name: ðŸ“¦ Package Helm chart
        run: helm package ${PATH_HELM_CHART} --version ${{ steps.version.outputs.version }}

      - name: ðŸ“Œ Push Docker image
        run: docker push ${OCI_REGISTRY}/${GITHUB_REPOSITORY@L}/${PACKAGE_DOCKER}:${{ steps.version.outputs.version }}

      - name: ðŸ“Œ Push Helm chart
        run: helm push ${PACKAGE_HELM}-${{ steps.version.outputs.version }}.tgz oci://${OCI_REGISTRY}/${GITHUB_REPOSITORY@L}

      - name: ðŸš€ Upgrade Helm chart
        run: >
          helm upgrade ${HELM_RELEASE} oci://${OCI_REGISTRY}/${GITHUB_REPOSITORY@L}/${PACKAGE_HELM}
          --install --force --take-ownership
          --version ${{ steps.version.outputs.version }}
          --kube-apiserver ${{ secrets.SERVER }}
          --kube-token ${{ secrets.TOKEN }}
          --kube-ca-file ${PATH_CA_FILE}
          --namespace ${KUBE_NAMESPACE}

      - name: ðŸ“£ Create GH release
        run: gh release create ${{ steps.version.outputs.version }} --generate-notes
